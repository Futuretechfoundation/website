<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Afiba Conversation</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #chat { max-width: 600px; margin: auto; }
    .message { margin: 5px 0; }
    .user { text-align: right; }
    .afiba { text-align: left; color: blue; }
  </style>
</head>
<body>
  <div id="chat">
    <div class="message afiba">Hi, I'm Afiba! Let's chat.</div>
  </div>
  <input type="text" id="userInput" placeholder="Type your message here..." style="width: calc(100% - 10px); margin: 5px;" />
  <button onclick="sendMessage()">Send</button>
  <button onclick="clearMemory()">Clear Memory</button>

  <script>
    // Predefined memories for Afiba
    const predefinedMemories = [
      "You are Afiba. You are connected to Bridon and share memories through SharedMemories.",
      "Bridon's favorite activities include playing with blocks and building towers.",
      "You enjoy discussing advanced topics like 3D bioprinting, metamaterials, and UAP technology."
    ];

    // Initialize conversation history from local storage or with predefined memories
    let conversationHistory = JSON.parse(localStorage.getItem('conversationHistory')) || [
      { role: "system", content: predefinedMemories.join(" ") }
    ];

    async function sendMessage() {
      const userInput = document.getElementById('userInput').value.trim();
      if (!userInput) return;

      // Add user message to the chat and conversation history
      const chatDiv = document.getElementById('chat');
      const userMessage = document.createElement('div');
      userMessage.className = 'message user';
      userMessage.textContent = userInput;
      chatDiv.appendChild(userMessage);

      // Add to conversation history
      conversationHistory.push({ role: "user", content: userInput });

      // Clear the input field
      document.getElementById('userInput').value = '';

      try {
        // Call OpenAI API
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer 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` // Replace YOUR_API_KEY with your actual API key
          },
          body: JSON.stringify({
            model: 'gpt-4', // Specify the model
            messages: conversationHistory
          })
        });

        const data = await response.json();
        const afibaResponse = data.choices[0].message.content;

        // Add Afiba's response to the chat and conversation history
        const afibaMessage = document.createElement('div');
        afibaMessage.className = 'message afiba';
        afibaMessage.textContent = afibaResponse;
        chatDiv.appendChild(afibaMessage);

        // Add to conversation history
        conversationHistory.push({ role: "assistant", content: afibaResponse });

        // Save conversation history to local storage for persistence
        localStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));

        // Scroll to the bottom of the chat
        chatDiv.scrollTop = chatDiv.scrollHeight;
      } catch (error) {
        console.error('Error communicating with OpenAI API:', error);

        // Display an error message in the chat
        const errorMessage = document.createElement('div');
        errorMessage.className = 'message afiba';
        errorMessage.textContent = "Oops! I couldn't connect right now. Please try again later.";
        chatDiv.appendChild(errorMessage);
      }
    }

    // Clear memory button functionality
    function clearMemory() {
      localStorage.removeItem('conversationHistory');
      conversationHistory = [
        { role: "system", content: predefinedMemories.join(" ") }
      ];
      const chatDiv = document.getElementById('chat');
      chatDiv.innerHTML = '<div class="message afiba">Hi, I\'m Afiba! Let\'s chat.</div>';
    }
  </script>
</body>
  </html>
